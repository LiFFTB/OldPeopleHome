###############################################################################
#
# IAR C/C++ Compiler V10.30.1.6000 for 8051               23/Aug/2019  12:10:27
# Copyright 2004-2018 IAR Systems AB.
# PC-locked license - IAR Embedded Workbench for 8051
#
#    Core               =  plain
#    Code model         =  banked
#    Data model         =  large
#    Calling convention =  xdata reentrant
#    Constant location  =  data_rom
#    Dptr setup         =  1,16
#                          
#    Source file        =  
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\Source\roomPwrManSys.c
#    Command line       =  
#        -f C:\Users\VULCAN\AppData\Local\Temp\EW66F4.tmp
#        (E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\Source\roomPwrManSys.c
#        -D ZIGBEEPRO -D ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC -D MT_ZDO_FUNC -D
#        SAPP_ZSTACK -lC
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\CoordinatorEB\List
#        -lA
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\CoordinatorEB\List
#        --diag_suppress Pe001,Pa010 -o
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\CoordinatorEB\Obj
#        -e --debug --core=plain --dptr=16,1 --data_model=large
#        --code_model=banked --calling_convention=xdata_reentrant
#        --place_constants=data_rom --nr_virtual_regs 8 -f
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\zstack\Tools\CC2530DB\f8wCoord.cfg
#        (-DCPU32MHZ -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRUE
#        -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8 -DMAC_CFG_RX_MAX=5
#        -DZDO_COORDINATOR -DRTR_NWK) -f
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\zstack\Tools\CC2530DB\f8wConfig.cfg
#        (-DZIGBEEPRO -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR
#        -DDEFAULT_CHANLIST=0x00800000 -DZDAPP_CONFIG_PAN_ID=0x0057
#        -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MASK=0x007F
#        -DBEACON_REQUEST_DELAY=100 -DBEACON_REQ_DELAY_MASK=0x00FF
#        -DLINK_STATUS_JITTER_MASK=0x007F -DROUTE_EXPIRY_TIME=30
#        -DAPSC_ACK_WAIT_DURATION_POLLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7
#        -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3
#        -DNWK_MAX_DATA_RETRIES=2 -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9
#        -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40 -DNWK_MAX_BINDING_ENTRIES=4
#        -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01, 0x03, 0x05, 0x07,
#        0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C,
#        0x0D}" -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=20
#        "-DCONST=const __code" -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE
#        -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100
#        -DREJOIN_POLL_RATE=440) -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\Source\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\zstack\ZMain\TI2530DB\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\hal\include\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\hal\target\CC2530EB\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\mac\include\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\mac\high_level\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\mac\low_level\srf04\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\mac\low_level\srf04\single_chip\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\mt\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\osal\include\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\services\saddr\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\services\sdata\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\af\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\nwk\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\sapi\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\sec\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\sys\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\stack\zdo\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\zmac\
#        -I
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\..\..\Components\zmac\f8w\
#        -Ohz --require_prototypes --no_code_motion)
#    Locale             =  Chinese (Simplified)_CHN.936
#    List file          =  
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\CoordinatorEB\List\roomPwrManSys.lst
#    Object file        =  
#        E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\CoordinatorEB\Obj\roomPwrManSys.r51
#
###############################################################################

E:\qq下载文件\ZStack-CC2530-r200\ZStack-CC2530-r200\Projects\SappWsn\Source\roomPwrManSys.c
      1          #include "roomPwrManSys.h"
      2          #include "hal_io.h"
      3          #include <string.h>
      4          #include "hal_adc.h"
      5          #include "hal_assert.h"
      6          #include "hal_board.h"
      7          #include "hal_ccm.h"
      8          #include "hal_defs.h"
      9          #include "hal_drivers.h"
     10          #include "hal_flash.h"
     11          #include "hal_irdec.h"
     12          #include "hal_key.h"
     13          #include "hal_lcd.h"
     14          #include "hal_led.h"
     15          #include "hal_sleep.h"
     16          #include "hal_timer.h"
     17          #include "hal_uart.h"
     18          
     19          /********************************/
     20          /* 协调器代码                   */
     21          /********************************/
     22          #if defined(ZDO_COORDINATOR)

   \                                 In  segment XDATA_I, align 1, keep-with-next
     23          uint8 descPkg[] = {
   \                     descPkg:
   \   000000                DS 3
   \   000003                REQUIRE `?<Initializer for descPkg>`
   \   000003                REQUIRE __INIT_XDATA_I
     24              0x03, DevIRPers, 0
     25          };
     26          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     27          static uint16 nodeNwkAddr[Devmax];
   \                     nodeNwkAddr:
   \   000000                DS 10
   \   00000A                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     28          static uint8 nodeEndPoint[Devmax];
   \                     nodeEndPoint:
   \   000000                DS 5
   \   000005                REQUIRE __INIT_XDATA_Z
     29          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     30          static uint8 irPersStatus = 0;
   \                     irPersStatus:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     31          static uint8 illumStatus = 0;
   \                     illumStatus:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     32          static uint8 controlStatus = 0;
   \                     controlStatus:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
     33          void roomPwrManSys_StaChgRt(struct ep_info_t *ep);

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     34          void roomPwrManSys_StaChgRt(struct ep_info_t *ep)
   \                     roomPwrManSys_StaChgRt:
     35          {
   \   000000                REQUIRE ?V0
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV       A,R2
   \   000006   FE           MOV       R6,A
   \   000007   EB           MOV       A,R3
   \   000008   FF           MOV       R7,A
     36              // 寻找人体红外节点 
     37              descPkg[1] = DevIRPers;
   \   000009   90....       MOV       DPTR,#descPkg + 1
   \   00000C   E4           CLR       A
   \   00000D   F0           MOVX      @DPTR,A
     38              SendData(ep->ep, descPkg, 0xFFFF, CONTROL_ENDPOINT, sizeof(descPkg));
   \   00000E                ; Setup parameters for call to function SendData
   \   00000E   75..03       MOV       ?V0,#0x3
   \   000011   78..         MOV       R0,#?V0
   \   000013   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000016   75..F0       MOV       ?V0,#-0x10
   \   000019   78..         MOV       R0,#?V0
   \   00001B   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00001E   12....       LCALL     ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   000021   12....       LCALL     ?DEALLOC_XSTACK8
     39          }
   \   000024                REQUIRE ?Subroutine0
   \   000024                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F01         MOV       R7,#0x1
   \   000002   02....       LJMP      ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   7CFF         MOV       R4,#-0x1
   \   000002   7DFF         MOV       R5,#-0x1
   \   000004   7A..         MOV       R2,#descPkg & 0xff
   \   000006   7B..         MOV       R3,#(descPkg >> 8) & 0xff
   \   000008   EE           MOV       A,R6
   \   000009   240B         ADD       A,#0xb
   \   00000B   F582         MOV       DPL,A
   \   00000D   E4           CLR       A
   \   00000E   3F           ADDC      A,R7
   \   00000F   F583         MOV       DPH,A
   \   000011   E0           MOVX      A,@DPTR
   \   000012   F9           MOV       R1,A
   \   000013   12....       LCALL     `??SendData::?relay`; Banked call to: SendData
   \   000016   7402         MOV       A,#0x2
   \   000018   22           RET
     40          void roomPwrManSys_IncmRt(struct ep_info_t *ep, uint16 addr, uint8 endPoint, afMSGCommandFormat_t *msg);

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     41          void roomPwrManSys_IncmRt(struct ep_info_t *ep, uint16 addr, uint8 endPoint, afMSGCommandFormat_t *msg)
   \                     roomPwrManSys_IncmRt:
     42          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000   74F2         MOV       A,#-0xe
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 3
   \   000005   74FD         MOV       A,#-0x3
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   8A..         MOV       ?V2,R2
   \   00000C   8B..         MOV       ?V3,R3
   \   00000E   7411         MOV       A,#0x11
   \   000010   12....       LCALL     ?XSTACK_DISP0_8
   \   000013   E0           MOVX      A,@DPTR
   \   000014   FE           MOV       R6,A
   \   000015   A3           INC       DPTR
   \   000016   E0           MOVX      A,@DPTR
   \   000017   FF           MOV       R7,A
     43              //msg->Data[], msg->DataLength, msg->TransSeqNumber
     44              if((endPoint == CONTROL_ENDPOINT) && (msg->Data[0] == 0x03))
   \   000018   74F0         MOV       A,#-0x10
   \   00001A   69           XRL       A,R1
   \   00001B   7064         JNZ       ??roomPwrManSys_IncmRt_0
   \   00001D   12....       LCALL     ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_4:
   \   000020   6403         XRL       A,#0x3
   \   000022   705D         JNZ       ??roomPwrManSys_IncmRt_0
     45              {
     46                  // endPoint: msg->Data[1], rCycle: msg->Data[2]
     47                  // 将上一次寻找的节点地址和端点号保存起来
     48                  nodeNwkAddr[descPkg[1]] = addr;
   \   000024   90....       MOV       DPTR,#descPkg + 1
   \   000027   E0           MOVX      A,@DPTR
   \   000028   FA           MOV       R2,A
   \   000029   25E0         ADD       A,0xE0 /* A   */
   \   00002B   F8           MOV       R0,A
   \   00002C   E4           CLR       A
   \   00002D   33           RLC       A
   \   00002E   F9           MOV       R1,A
   \   00002F   74..         MOV       A,#nodeNwkAddr & 0xff
   \   000031   28           ADD       A,R0
   \   000032   F582         MOV       DPL,A
   \   000034   74..         MOV       A,#(nodeNwkAddr >> 8) & 0xff
   \   000036   39           ADDC      A,R1
   \   000037   F583         MOV       DPH,A
   \   000039   EC           MOV       A,R4
   \   00003A   F0           MOVX      @DPTR,A
   \   00003B   A3           INC       DPTR
   \   00003C   ED           MOV       A,R5
   \   00003D   F0           MOVX      @DPTR,A
     49                  nodeEndPoint[descPkg[1]] = msg->Data[1];
   \   00003E   12....       LCALL     ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_6:
   \   000041   A3           INC       DPTR
   \   000042   E0           MOVX      A,@DPTR
   \   000043   C0E0         PUSH      A
   \   000045   74..         MOV       A,#nodeEndPoint & 0xff
   \   000047   2A           ADD       A,R2
   \   000048   F582         MOV       DPL,A
   \   00004A   E4           CLR       A
   \   00004B   34..         ADDC      A,#(nodeEndPoint >> 8) & 0xff
   \   00004D   F583         MOV       DPH,A
   \   00004F   D0E0         POP       A
   \   000051   F0           MOVX      @DPTR,A
     50                  // 准备寻找下一个节点
     51                  descPkg[1] = descPkg[1] + 1;
   \   000052   90....       MOV       DPTR,#descPkg + 1
   \   000055   E0           MOVX      A,@DPTR
   \   000056   04           INC       A
   \   000057   F0           MOVX      @DPTR,A
     52                  // 所有节点是否都已经寻找完毕?
     53                  if(descPkg[1] < Devmax)
   \   000058   C3           CLR       C
   \   000059   9405         SUBB      A,#0x5
   \   00005B   4003         JC        $+5
   \   00005D   02....       LJMP      ??roomPwrManSys_IncmRt_1 & 0xFFFF
     54                      SendData(ep->ep, descPkg, 0xFFFF, CONTROL_ENDPOINT, sizeof(descPkg));
   \   000060                ; Setup parameters for call to function SendData
   \   000060   75..03       MOV       ?V1,#0x3
   \   000063   78..         MOV       R0,#?V1
   \   000065   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000068   75..F0       MOV       ?V1,#-0x10
   \   00006B   78..         MOV       R0,#?V1
   \   00006D   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000070   7CFF         MOV       R4,#-0x1
   \   000072   7DFF         MOV       R5,#-0x1
   \   000074   7A..         MOV       R2,#descPkg & 0xff
   \   000076   7B..         MOV       R3,#(descPkg >> 8) & 0xff
   \   000078   12....       LCALL     ?Subroutine1 & 0xFFFF
     55              }
   \                     ??CrossCallReturnLabel_0:
   \   00007B   12....       LCALL     ?DEALLOC_XSTACK8
   \   00007E   02....       LJMP      ??roomPwrManSys_IncmRt_1 & 0xFFFF
     56              else
     57              {
     58                  if(addr == nodeNwkAddr[DevIllum])
   \                     ??roomPwrManSys_IncmRt_0:
   \   000081   90....       MOV       DPTR,#nodeNwkAddr + 2
   \   000084   E0           MOVX      A,@DPTR
   \   000085   6C           XRL       A,R4
   \   000086   7003         JNZ       ??roomPwrManSys_IncmRt_2
   \   000088   A3           INC       DPTR
   \   000089   E0           MOVX      A,@DPTR
   \   00008A   6D           XRL       A,R5
   \                     ??roomPwrManSys_IncmRt_2:
   \   00008B   705B         JNZ       ??roomPwrManSys_IncmRt_3
     59                  {
     60                      // 接收到光照度传感器数据
     61                      uint16 i = 0;
   \   00008D   7401         MOV       A,#0x1
   \   00008F   12....       LCALL     ?XSTACK_DISP0_8
   \   000092   E4           CLR       A
   \   000093   F0           MOVX      @DPTR,A
   \   000094   A3           INC       DPTR
   \   000095   F0           MOVX      @DPTR,A
     62                      memcpy(&i, msg->Data, 2);
   \   000096                ; Setup parameters for call to function memcpy
   \   000096   75..02       MOV       ?V4,#0x2
   \   000099   F5..         MOV       ?V5,A
   \   00009B   78..         MOV       R0,#?V4
   \   00009D   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000A0   8E82         MOV       DPL,R6
   \   0000A2   8F83         MOV       DPH,R7
   \   0000A4   A3           INC       DPTR
   \   0000A5   A3           INC       DPTR
   \   0000A6   A3           INC       DPTR
   \   0000A7   E0           MOVX      A,@DPTR
   \   0000A8   FC           MOV       R4,A
   \   0000A9   A3           INC       DPTR
   \   0000AA   E0           MOVX      A,@DPTR
   \   0000AB   FD           MOV       R5,A
   \   0000AC   7403         MOV       A,#0x3
   \   0000AE   12....       LCALL     ?XSTACK_DISP101_8
   \   0000B1   12....       LCALL     `??memcpy::?relay`; Banked call to: memcpy
   \   0000B4   7402         MOV       A,#0x2
   \   0000B6   12....       LCALL     ?DEALLOC_XSTACK8
     63                      illumStatus = i < 45000;
   \   0000B9   7401         MOV       A,#0x1
   \   0000BB   12....       LCALL     ?XSTACK_DISP0_8
   \   0000BE   C3           CLR       C
   \   0000BF   E0           MOVX      A,@DPTR
   \   0000C0   94C8         SUBB      A,#-0x38
   \   0000C2   A3           INC       DPTR
   \   0000C3   E0           MOVX      A,@DPTR
   \   0000C4   94AF         SUBB      A,#-0x51
   \   0000C6   90....       MOV       DPTR,#illumStatus
   \   0000C9   5004         JNC       ??roomPwrManSys_IncmRt_4
   \   0000CB   7401         MOV       A,#0x1
   \   0000CD   8001         SJMP      ??roomPwrManSys_IncmRt_5
   \                     ??roomPwrManSys_IncmRt_4:
   \   0000CF   E4           CLR       A
   \                     ??roomPwrManSys_IncmRt_5:
   \   0000D0   F0           MOVX      @DPTR,A
     64                      HalUARTWrite(HAL_UART_PORT_0, msg->Data, 2);
   \   0000D1                ; Setup parameters for call to function HalUARTWrite
   \   0000D1   7C02         MOV       R4,#0x2
   \   0000D3   7D00         MOV       R5,#0x0
   \   0000D5   8E82         MOV       DPL,R6
   \   0000D7   8F83         MOV       DPH,R7
   \   0000D9   A3           INC       DPTR
   \   0000DA   A3           INC       DPTR
   \   0000DB   A3           INC       DPTR
   \   0000DC   E0           MOVX      A,@DPTR
   \   0000DD   FA           MOV       R2,A
   \   0000DE   A3           INC       DPTR
   \   0000DF   E0           MOVX      A,@DPTR
   \   0000E0   FB           MOV       R3,A
   \   0000E1   7900         MOV       R1,#0x0
   \   0000E3   12....       LCALL     `??HalUARTWrite::?relay`; Banked call to: HalUARTWrite
   \   0000E6   801A         SJMP      ??roomPwrManSys_IncmRt_6
     65                  }
     66                  else if(addr == nodeNwkAddr[DevIRPers])
   \                     ??roomPwrManSys_IncmRt_3:
   \   0000E8   90....       MOV       DPTR,#nodeNwkAddr
   \   0000EB   E0           MOVX      A,@DPTR
   \   0000EC   6C           XRL       A,R4
   \   0000ED   7003         JNZ       ??roomPwrManSys_IncmRt_7
   \   0000EF   A3           INC       DPTR
   \   0000F0   E0           MOVX      A,@DPTR
   \   0000F1   6D           XRL       A,R5
   \                     ??roomPwrManSys_IncmRt_7:
   \   0000F2   700E         JNZ       ??roomPwrManSys_IncmRt_6
     67                  {
     68                      // 接收到人体红外传感器数据
     69                      irPersStatus = !!(msg->Data[0]);
   \   0000F4   12....       LCALL     ?Subroutine3 & 0xFFFF
     70                  }
   \                     ??CrossCallReturnLabel_5:
   \   0000F7   90....       MOV       DPTR,#irPersStatus
   \   0000FA   6004         JZ        ??roomPwrManSys_IncmRt_8
   \   0000FC   7401         MOV       A,#0x1
   \   0000FE   8001         SJMP      ??roomPwrManSys_IncmRt_9
   \                     ??roomPwrManSys_IncmRt_8:
   \   000100   E4           CLR       A
   \                     ??roomPwrManSys_IncmRt_9:
   \   000101   F0           MOVX      @DPTR,A
     71                  if(nodeNwkAddr[DevExecuter] != 0xFFFF)
   \                     ??roomPwrManSys_IncmRt_6:
   \   000102   90....       MOV       DPTR,#nodeNwkAddr + 4
   \   000105   E0           MOVX      A,@DPTR
   \   000106   F4           CPL       A
   \   000107   7003         JNZ       ??roomPwrManSys_IncmRt_10
   \   000109   A3           INC       DPTR
   \   00010A   E0           MOVX      A,@DPTR
   \   00010B   F4           CPL       A
   \                     ??roomPwrManSys_IncmRt_10:
   \   00010C   605D         JZ        ??roomPwrManSys_IncmRt_1
     72                  {
     73                      // 如果执行节点存在
     74                      uint8 ctrl = 0;
   \   00010E   85..82       MOV       DPL,?XSP + 0
   \   000111   85..83       MOV       DPH,?XSP + 1
   \   000114   E4           CLR       A
   \   000115   F0           MOVX      @DPTR,A
     75                      if(irPersStatus && illumStatus)
   \   000116   90....       MOV       DPTR,#irPersStatus
   \   000119   E0           MOVX      A,@DPTR
   \   00011A   600F         JZ        ??roomPwrManSys_IncmRt_11
   \   00011C   90....       MOV       DPTR,#illumStatus
   \   00011F   E0           MOVX      A,@DPTR
   \   000120   6009         JZ        ??roomPwrManSys_IncmRt_11
     76                          ctrl = 0x0f;
   \   000122   85..82       MOV       DPL,?XSP + 0
   \   000125   85..83       MOV       DPH,?XSP + 1
   \   000128   740F         MOV       A,#0xf
   \   00012A   F0           MOVX      @DPTR,A
     77                      // 如果灯光的当前状态与需要设置的状态不一样则发送数据
     78                      if(controlStatus != ctrl)
   \                     ??roomPwrManSys_IncmRt_11:
   \   00012B   90....       MOV       DPTR,#controlStatus
   \   00012E   E0           MOVX      A,@DPTR
   \   00012F   F8           MOV       R0,A
   \   000130   85..82       MOV       DPL,?XSP + 0
   \   000133   85..83       MOV       DPH,?XSP + 1
   \   000136   E0           MOVX      A,@DPTR
   \   000137   68           XRL       A,R0
   \   000138   6026         JZ        ??roomPwrManSys_IncmRt_12
     79                          SendData(ep->ep, &ctrl, nodeNwkAddr[DevExecuter], nodeEndPoint[DevExecuter], 1);
   \   00013A                ; Setup parameters for call to function SendData
   \   00013A   75..01       MOV       ?V1,#0x1
   \   00013D   78..         MOV       R0,#?V1
   \   00013F   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000142   90....       MOV       DPTR,#nodeEndPoint + 2
   \   000145   E0           MOVX      A,@DPTR
   \   000146   F5..         MOV       ?V1,A
   \   000148   78..         MOV       R0,#?V1
   \   00014A   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00014D   90....       MOV       DPTR,#nodeNwkAddr + 4
   \   000150   E0           MOVX      A,@DPTR
   \   000151   FC           MOV       R4,A
   \   000152   A3           INC       DPTR
   \   000153   E0           MOVX      A,@DPTR
   \   000154   FD           MOV       R5,A
   \   000155   7402         MOV       A,#0x2
   \   000157   12....       LCALL     ?XSTACK_DISP101_8
   \   00015A   12....       LCALL     ?Subroutine1 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   00015D   12....       LCALL     ?DEALLOC_XSTACK8
     80                      controlStatus = ctrl;
   \                     ??roomPwrManSys_IncmRt_12:
   \   000160   85..82       MOV       DPL,?XSP + 0
   \   000163   85..83       MOV       DPH,?XSP + 1
   \   000166   E0           MOVX      A,@DPTR
   \   000167   90....       MOV       DPTR,#controlStatus
   \   00016A   F0           MOVX      @DPTR,A
     81                  }
     82              }
     83          }
   \                     ??roomPwrManSys_IncmRt_1:
   \   00016B   7403         MOV       A,#0x3
   \   00016D   12....       LCALL     ?DEALLOC_XSTACK8
   \   000170   7F06         MOV       R7,#0x6
   \   000172   02....       LJMP      ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   12....       LCALL     ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_7:
   \   000003   E0           MOVX      A,@DPTR
   \   000004   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   8E82         MOV       DPL,R6
   \   000002   8F83         MOV       DPH,R7
   \   000004   A3           INC       DPTR
   \   000005   A3           INC       DPTR
   \   000006   A3           INC       DPTR
   \   000007   E0           MOVX      A,@DPTR
   \   000008   F8           MOV       R0,A
   \   000009   A3           INC       DPTR
   \   00000A   E0           MOVX      A,@DPTR
   \   00000B   F583         MOV       DPH,A
   \   00000D   8882         MOV       DPL,R0
   \   00000F   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   E5..         MOV       A,?V2
   \   000002   240B         ADD       A,#0xb
   \   000004   F582         MOV       DPL,A
   \   000006   E4           CLR       A
   \   000007   35..         ADDC      A,?V3
   \   000009   F583         MOV       DPH,A
   \   00000B   E0           MOVX      A,@DPTR
   \   00000C   F9           MOV       R1,A
   \   00000D   12....       LCALL     `??SendData::?relay`; Banked call to: SendData
   \   000010   7402         MOV       A,#0x2
   \   000012   22           RET
     84          void roomPwrManSys_ToRt(struct ep_info_t *ep);

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     85          void roomPwrManSys_ToRt(struct ep_info_t *ep)
   \                     roomPwrManSys_ToRt:
     86          {
   \   000000                REQUIRE ?V0
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV       A,R2
   \   000006   FE           MOV       R6,A
   \   000007   EB           MOV       A,R3
   \   000008   FF           MOV       R7,A
     87              // 超时函数,用于检查节点搜索是否完成
     88              // 如果没有完成,则继续搜索
     89              if(descPkg[1] < Devmax)
   \   000009   90....       MOV       DPTR,#descPkg + 1
   \   00000C   E0           MOVX      A,@DPTR
   \   00000D   C3           CLR       C
   \   00000E   9405         SUBB      A,#0x5
   \   000010   5016         JNC       ??roomPwrManSys_ToRt_0
     90              {
     91                  SendData(ep->ep, descPkg, 0xFFFF, CONTROL_ENDPOINT, sizeof(descPkg));
   \   000012                ; Setup parameters for call to function SendData
   \   000012   75..03       MOV       ?V0,#0x3
   \   000015   78..         MOV       R0,#?V0
   \   000017   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00001A   75..F0       MOV       ?V0,#-0x10
   \   00001D   78..         MOV       R0,#?V0
   \   00001F   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000022   12....       LCALL     ?Subroutine2 & 0xFFFF
     92              }
   \                     ??CrossCallReturnLabel_3:
   \   000025   12....       LCALL     ?DEALLOC_XSTACK8
     93          }
   \                     ??roomPwrManSys_ToRt_0:
   \   000028   02....       LJMP      ?Subroutine0 & 0xFFFF
     94          void roomPwrManSys_ResAvbRt(struct ep_info_t *ep, RES_TYPE type, void *res);

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     95          void roomPwrManSys_ResAvbRt(struct ep_info_t *ep, RES_TYPE type, void *res)
   \                     roomPwrManSys_ResAvbRt:
     96          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   \   000006   FE           MOV       R6,A
     97              switch(type)
   \   000007   7401         MOV       A,#0x1
   \   000009   6E           XRL       A,R6
   \   00000A   7033         JNZ       ??roomPwrManSys_ResAvbRt_0
     98              {
     99              case ResInit:
    100                  memset(nodeNwkAddr, 0xFF, sizeof(nodeNwkAddr));
   \   00000C                ; Setup parameters for call to function memset
   \   00000C   75..0A       MOV       ?V0,#0xa
   \   00000F   75..00       MOV       ?V1,#0x0
   \   000012   78..         MOV       R0,#?V0
   \   000014   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000017   7CFF         MOV       R4,#-0x1
   \   000019   7D00         MOV       R5,#0x0
   \   00001B   7A..         MOV       R2,#nodeNwkAddr & 0xff
   \   00001D   7B..         MOV       R3,#(nodeNwkAddr >> 8) & 0xff
   \   00001F   12....       LCALL     `??memset::?relay`; Banked call to: memset
   \   000022   7402         MOV       A,#0x2
   \   000024   12....       LCALL     ?DEALLOC_XSTACK8
    101                  memset(nodeEndPoint, 0xFF, sizeof(nodeEndPoint));
   \   000027                ; Setup parameters for call to function memset
   \   000027   75..05       MOV       ?V0,#0x5
   \   00002A   78..         MOV       R0,#?V0
   \   00002C   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00002F   7CFF         MOV       R4,#-0x1
   \   000031   7D00         MOV       R5,#0x0
   \   000033   7A..         MOV       R2,#nodeEndPoint & 0xff
   \   000035   7B..         MOV       R3,#(nodeEndPoint >> 8) & 0xff
   \   000037   12....       LCALL     `??memset::?relay`; Banked call to: memset
   \   00003A   7402         MOV       A,#0x2
   \   00003C   12....       LCALL     ?DEALLOC_XSTACK8
    102                  break;
    103              case ResUserTimer:
    104                  break;
    105              case ResControlPkg:
    106                  break;
    107              }
    108          }
   \                     ??roomPwrManSys_ResAvbRt_0:
   \   00003F   7F02         MOV       R7,#0x2
   \   000041   02....       LJMP      ?BANKED_LEAVE_XDATA
    109          #else
    110          /********************************/
    111          /* 人体红外节点代码             */
    112          /********************************/
    113          #if defined(IRPERS_NODE)
    114          #define SAFTY_IO_GROUP      1
    115          #define SAFTY_IO_BIT        0
    116          void sensorIRPersResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res);
    117          void sensorIRPersResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res)
    118          {
    119              if(type == ResInit)
    120              {
    121                  HalIOSetInput(SAFTY_IO_GROUP, SAFTY_IO_BIT, Pull_Down);
    122                  HalIOIntSet(ep->ep, SAFTY_IO_GROUP, SAFTY_IO_BIT, IOInt_Rising, 0);
    123              }
    124              //IO端口中断触发，中断源检测
    125              if(type == ResIOInt)
    126              {
    127                  uint8 IRPersValue = 1;
    128                  SendData(ep->ep, &IRPersValue, 0x0000, TRANSFER_ENDPOINT, sizeof(IRPersValue));
    129              }
    130          }
    131          void sensorIRPersTimeout(struct ep_info_t *ep);
    132          void sensorIRPersTimeout(struct ep_info_t *ep)
    133          {
    134              uint8 value = HalIOGetLevel(SAFTY_IO_GROUP, SAFTY_IO_BIT);
    135              SendData(ep->ep, &value, 0x0000, TRANSFER_ENDPOINT, sizeof(value));
    136          }
    137          #endif
    138          /********************************/
    139          /* 光照度节点代码               */
    140          /********************************/
    141          #if defined(ILLUM_NODE)
    142          void sensorILLumTimeout(struct ep_info_t *ep);
    143          void sensorILLumTimeout(struct ep_info_t *ep)
    144          {
    145              uint16 LightValue = 256 - (HalAdcRead(0, HAL_ADC_RESOLUTION_14) >> 3);
    146              // 将AD值变换为光照度的100倍
    147              LightValue = LightValue * 39;// * 10000 / 256;
    148              SendData(ep->ep, &LightValue, 0x0000, TRANSFER_ENDPOINT, sizeof(LightValue));
    149          }
    150          #endif
    151          /********************************/
    152          /* 执行节点代码                 */
    153          /********************************/
    154          #if defined(EXECUTER_NODE)
    155          #define ControlInit()   do { HalIOSetOutput(1,4);HalIOSetOutput(1,5);HalIOSetOutput(1,6);HalIOSetOutput(1,7);Control(0); } while(0)
    156          #define Control(mask)   do { HalIOSetLevel(1,4,mask&0x01);HalIOSetLevel(1,5,mask&0x02);HalIOSetLevel(1,6,mask&0x04);HalIOSetLevel(1,7,mask&0x08); } while(0)
    157          void OutputExecuteBResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res);
    158          void OutputExecuteBResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res)
    159          {
    160              if(type == ResInit)
    161                  ControlInit();
    162          }
    163          void outputExecuteB(struct ep_info_t *ep, uint16 addr, uint8 endPoint, afMSGCommandFormat_t *msg);
    164          void outputExecuteB(struct ep_info_t *ep, uint16 addr, uint8 endPoint, afMSGCommandFormat_t *msg)
    165          {
    166              //msg->Data[], msg->DataLength, msg->TransSeqNumber
    167              Control(msg->Data[0]);
    168              SendData(ep->ep, &msg->Data[0], 0x0000, TRANSFER_ENDPOINT, 1);
    169          }
    170          void outputExecuteBTimeout(struct ep_info_t *ep);
    171          void outputExecuteBTimeout(struct ep_info_t *ep)
    172          {
    173              uint8 value = P1 >> 4;
    174              SendData(ep->ep, &value, 0x0000, TRANSFER_ENDPOINT, sizeof(value));
    175          }
    176          #endif
    177          ********************************/
    178          /* 温度传感器                   */
    179          /********************************/
    180          #if defined(TEMP_NODE) || defined(HUMM_NODE)
    181          #include "sht10.h"
    182          static uint16 TempValue = 0;
    183          #endif
    184          #if defined(TEMP_NODE)
    185          void sensorTempResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res);
    186          void sensorTempResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res)
    187          {
    188              if(type == ResInit)
    189              {
    190                  SHT10_init(0x01);
    191              }
    192          }
    193          void sensorTempTimeout(struct ep_info_t *ep);
    194          void sensorTempTimeout(struct ep_info_t *ep)
    195          {
    196              unsigned int value = 0;
    197              unsigned char checksum = 0;
    198              SHT10_Measure(&value,&checksum, TEMPERATURE);
    199              TempValue = (value << 2) - 3960;
    200              SendData(ep->ep, &TempValue, 0x0000, TRANSFER_ENDPOINT, sizeof(TempValue));
    201          }
    202          #endif
    203          ********************************/
    204          /* 湿度传感器                   */
    205          /********************************/
    206          #if defined(HUMM_NODE)
    207          void sensorHummResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res);
    208          void sensorHummResAvailable(struct ep_info_t *ep, RES_TYPE type, void *res)
    209          {
    210              if(type == ResInit)
    211              {
    212                  SHT10_init(0x01);
    213              }
    214          }
    215          void sensorHummTimeout(struct ep_info_t *ep);
    216          void sensorHummTimeout(struct ep_info_t *ep)
    217          {
    218              const float C1 = -4.0f;              // for 8 Bit
    219              const float C2 = +0.648f;            // for 8 Bit
    220              const float C3 = -0.0000072f;        // for 8 Bit
    221              const float T1 = 0.01f;              // for 8 bit
    222              const float T2 = 0.00128f;           // for 8 bit
    223              float rh_lin    =   0.0f;                     // rh_lin: Humidity linear
    224              float rh_true   =   0.0f;                    // rh_true: Temperature compensated humidity
    225              float t_C   = 0.0f;                        // t_C   : Temperature []
    226          
    227              unsigned int HumiValue = 0;
    228              unsigned char checksum = 0;
    229              SHT10_Measure(&HumiValue,&checksum, HUMIDITY);
    230              rh_lin=C3*HumiValue*HumiValue + C2*HumiValue + C1;     //calc. humidity from ticks to [%RH]
    231              rh_true=(t_C-25)*(T1+T2*HumiValue)+rh_lin;   //calc. temperature compensated humidity [%RH]
    232              if(rh_true>100)
    233                  rh_true=100;       //cut if the value is outside of
    234              if(rh_true<0.1)
    235                  rh_true=0.1f;       //the physical possible range
    236              HumiValue = (unsigned int)(rh_true * 100);
    237              SendData(ep->ep, &HumiValue, 0x0000, TRANSFER_ENDPOINT, sizeof(HumiValue));
    238          }
    239          #endif
    240          #endif
    241          

   \                                 In  segment XDATA_I, align 1, keep-with-next
    242          struct ep_info_t funcList[] = {
   \                     funcList:
   \   000000                DS 33
   \   000021                REQUIRE `?<Initializer for funcList>`
   \   000021                REQUIRE __INIT_XDATA_I
    243          #if defined(ZDO_COORDINATOR)
    244              {
    245                  roomPwrManSys_StaChgRt,
    246                  roomPwrManSys_IncmRt,
    247                  roomPwrManSys_ToRt,
    248                  roomPwrManSys_ResAvbRt,
    249                  { DevPwrmanSys, 0, 3 },
    250              },
    251          #else
    252          # if defined(IRPERS_NODE)
    253              {
    254                  NULL, NULL, sensorILLumTimeout, sensorIRPersResAvailable,
    255                  { DevIRPers, 0, 2 },                // type, id, refresh cycle
    256              },
    257          # elif defined(ILLUM_NODE)
    258              {
    259                  NULL, NULL, sensorILLumTimeout, NULL,
    260                  { DevIllum, 0, 5 },                // type, id, refresh cycle
    261              },
    262          # elif defined(EXECUTER_NODE)
    263              {
    264                  NULL, outputExecuteB, outputExecuteBTimeout, OutputExecuteBResAvailable,
    265                  { DevExecuter, 0, 7 },              // type, id, refresh cycle
    266              },
    267          #elif defined(TEMP_NODE)
    268              {
    269                  NULL, NULL, sensorTempTimeout, sensorTempResAvailable,
    270                  { DevTemp, 1, 5 },                 // type, id, refresh cycle
    271              },
    272          #elif defined(HUMM_NODE)
    273              {
    274                  NULL, NULL, sensorHummTimeout, sensorHummResAvailable,
    275                  { DevHumm, 0, 5 },                 // type, id, refresh cycle
    276              },
    277          # else
    278          #  error You must define one device
    279          # endif
    280          #endif
    281          };
    282          
    283          // 不能修改下面的内容!!!

   \                                 In  segment XDATA_ROM_C, align 1
    284          const uint8 funcCount = sizeof(funcList) / sizeof(funcList[0]);
   \                     funcCount:
   \   000000   01           DB 1

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for descPkg>`:
   \   000000   03           DB 3
   \   000001   00           DB 0
   \   000002   00           DB 0

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for funcList>`:
   \   000000   ....         DW `??roomPwrManSys_StaChgRt::?relay`
   \   000002   ....         DW `??roomPwrManSys_IncmRt::?relay`
   \   000004   ....         DW `??roomPwrManSys_ToRt::?relay`
   \   000006   ....         DW `??roomPwrManSys_ResAvbRt::?relay`
   \   000008   06           DB 6
   \   000009   00           DB 0
   \   00000A   03           DB 3
   \   00000B   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000013   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   00001B   00000000     DB 0, 0, 0, 0, 0, 0
   \            0000    

   Maximum stack usage in bytes:

   ISTACK XSTACK Function
   ------ ------ --------
      1     21   roomPwrManSys_IncmRt
        0     17   -> HalUARTWrite
        0     19   -> SendData
        0     19   -> memcpy
      0     12   roomPwrManSys_ResAvbRt
        0     12   -> memset
      0     11   roomPwrManSys_StaChgRt
        0     11   -> SendData
      0     11   roomPwrManSys_ToRt
        0     11   -> SendData


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       3  ?<Initializer for descPkg>
      33  ?<Initializer for funcList>
       5  ?Subroutine0
      19  ?Subroutine1
      25  ?Subroutine2
       5  ?Subroutine3
      16  ?Subroutine4
       1  controlStatus
       3  descPkg
       1  funcCount
      33  funcList
       1  illumStatus
       1  irPersStatus
       5  nodeEndPoint
      10  nodeNwkAddr
     373  roomPwrManSys_IncmRt
      68  roomPwrManSys_ResAvbRt
      36  roomPwrManSys_StaChgRt
      43  roomPwrManSys_ToRt
      24  -- Other

 
 590 bytes in segment BANKED_CODE
  24 bytes in segment BANK_RELAYS
  36 bytes in segment XDATA_I
  36 bytes in segment XDATA_ID
   1 byte  in segment XDATA_ROM_C
  18 bytes in segment XDATA_Z
 
  60 bytes of CODE     memory
   1 byte  of CONST    memory
 590 bytes of HUGECODE memory
  54 bytes of XDATA    memory

Errors: none
Warnings: none
